{% extends "base.html" %}

<!--
    Copyright 2009 Oregon State University

    This file is part of Pydra.

    Pydra is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Pydra is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Pydra.  If not, see <http://www.gnu.org/licenses/>.
-->

{% load pydra_extras %}

{% block head %}
    {{ block.super }}
        <script type="text/javascript" src="{{MEDIA_URL}}/js/jquery-1.3.1.min.js"></script>
        <script type="text/javascript" src="{{MEDIA_URL}}/js/jquery.progressbar.js"></script>
        <script type="text/javascript" src="{{MEDIA_URL}}/js/jquery.acts_as_tree_table.js"></script>
        <script type="text/javascript" src="{{MEDIA_URL}}/js/date.format.js"></script>

        <script>
            var can_run_tasks = {% if perms.pydra_server.can_run_tasks %}true{%else%}false{%endif%};

            $(document).ready(function() {
                //$('table[id^=taskstable-]').acts_as_tree_table({default_state:'collapsed'});

                //$('span.complete').hide();
                //$('span.progressbar').hide();
                //$('span.progressbar').progressBar({barImage: 'http://doors.osuosl.org/media/images/progressbg_yellow.gif', boxImage:'http://doors.osuosl.org/media/images/progressbar.gif'});

                $('.button_run').live('click', function(evt) {
                    $.post('run/', {'key':evt.target.parentNode.parentNode.id}, process_queued_task, 'json');
                });

                $('.button_cancel').live('click', function(evt) {
                    $.post('cancel/', {'i':evt.target.parentNode.parentNode.id});
                });

                // AUTO UPDATES ARE DISABLED
                update();
            });

            /* processes the response when queuing a task */
            function process_queued_task (data){
                // create html for entry
                task_name = data['task_key']
                task_instance = data['instance_id']
                task_description = $('#' + task_name).find('.description').html();

                time = new Date(parseInt(data['time'])*1000);
                formated_time = dateFormat(time, "yyyy-mm-dd HH:MM:ss")


                // construct html
                html = '<tr id="instance_'+ task_instance +'"><td>'+task_instance+'</td><td>'+ task_name +'</td><td>'+task_description+'</td><td class="queue_time">'+ formated_time +'</td>';
                if (can_run_tasks) {
                    html += '<td class="buttons"><a class="button_cancel" href="#">Cancel</a></td>'
                } else {
                    html += '<td></td>'
                }
                html += '</tr>'

                $('#queue').append(html);
                repaint_zebra_stripes('#queue');
            }


            var STATUS_FAILED = -1;
            var STATUS_STOPPED = 0;
            var STATUS_RUNNING = 1;
            var STATUS_PAUSED = 2;
            var STATUS_COMPLETE = 3;

            var CLASS_FAILED = 'status-failed';
            var CLASS_STOPPED = 'status-stopped';
            var CLASS_RUNNING = 'status-running';
            var CLASS_PAUSED = 'status-paused';
            var CLASS_COMPLETE = 'status-complete';

            function removeAllStatus(node){
                node.removeClass(CLASS_FAILED);
                node.removeClass(CLASS_STOPPED);
                node.removeClass(CLASS_RUNNING);
                node.removeClass(CLASS_PAUSED);
                node.removeClass(CLASS_COMPLETE);
            }


            /* process the progress message from the update */
            function processProgressData(data) {
                /*
                    Process queue changes by iterating each row from the queue
                    and running tables.  The status list will only contain
                    queued or running tasks so we can check status changes
                    from queued to running, and any absent tasks have completed
                    or stopped.
                */

                $('#queue tr:gt(1), #running tr:gt(1)').each(function(row){
                    id = this.id.slice(9);
                    status = data[id];

                    if (status == undefined) {
                        $(this).remove();
                    } else if (status['s'] == STATUS_RUNNING) {
                        if (this.parentNode.parentNode.id == 'queue') {
                            // move row to running table
                            $('#running').append(this);

                            // insert time started element
                            started = new Date(parseInt(status['t'])*1000);
                            started = dateFormat(started, "yyyy-mm-dd HH:MM:ss")
                            $(this).children('.queue_time').after('<td class="start_time">'+ started +'</td>')
                        }
                    }
                });

                repaint_zebra_stripes('#queue');
                repaint_zebra_stripes('#running');

            }


            /*
                update the zebra striping for a table.  This is required after
                an item has been removed from the middle of the list, or the
                order of the list has been changed
            */
            function repaint_zebra_stripes(table) {

                stripe = false;
                $(table + ' tr:gt(1)').each(function(index, row){
                    if (stripe) {
                        $(row).addClass('stripe');
                        stripe = false;
                    } else {
                        $(row).removeClass('stripe');
                        stripe = true;
                    }
                });
            }


            // function that updates progress bars
            // this code is from the proof-of-concept version of this page
            // it needs to be updated to work with this page.
            function updatebar() {
                statusMessage = JSON.parse(incommingJSON);
                for (key in statusMessage){
                    progressArray = statusMessage[key]['status'];

                    for (i=0; i<progressArray.length; i++){
                        // store array as vars for readability
                        id          = progressArray[i]['id'];
                        status      = progressArray[i]['status'];
                        progress    = progressArray[i]['progress'];
                        msg         = progressArray[i]['msg'];

                        taskSelectString = '#'+key+' #task-' + key + '-' + id
                        elt = $(taskSelectString);
                        // check status and update if needed
                        if (status == STATUS_STOPPED && !elt.hasClass(CLASS_STOPPED)) {
                            // hide progress bar 
                            if (elt.hasClass(CLASS_RUNNING) || elt.hasClass(CLASS_PAUSED)) {
                                $(taskSelectString + ' span.progressbar').hide()
                            }
                            //hide completion message
                            if (elt.hasClass(CLASS_COMPLETE)) {
                                $(taskSelectString + ' span.complete').hide()
                            }

                            //set status
                            removeAllStatus(elt);
                            elt.addClass(CLASS_STOPPED);


                        } else if (status == STATUS_RUNNING) {
                            //hide completion message
                            if (elt.hasClass(CLASS_COMPLETE)) {
                                $(taskSelectString + ' span.complete').hide()
                            }

                            // show statusbar
                            if (!(elt.hasClass(CLASS_RUNNING) || elt.hasClass(CLASS_PAUSED))) {
                                $(taskSelectString + ' span.progressbar').show();
                            }

                            // expand tree if needed
                            if (elt.hasClass('collapsed')) {
                                elt.toggle();
                            }

                            //update progressbar
                            $(taskSelectString + ' .progressbar').progressBar(progress);

                            //set status
                            removeAllStatus(elt);
                            elt.addClass(CLASS_RUNNING);

                        } else if (status == STATUS_PAUSED) {
                            // show statusbar
                            if (!(elt.hasClass(CLASS_RUNNING) || elt.hasClass(CLASS_PAUSED))) {
                                $(taskSelectString + ' span.progressbar').show();
                            }

                            //hide completion message
                            if (id.hasClass(CLASS_RUNNING) || id.hasClass(CLASS_PAUSED)) {
                                $(taskSelectString + ' span.complete').hide()
                            }

                            //set status
                            removeAllStatus(elt);
                            elt.addClass(STATUS_PAUSED);

                        } else if (status == STATUS_COMPLETE && !elt.hasClass(CLASS_COMPLETE)) {
                            // hide statusbar
                            if (elt.hasClass(CLASS_RUNNING) || elt.hasClass(CLASS_PAUSED)) {
                                bar = $(taskSelectString + ' span.progressbar')
                                bar.hide();
                                bar.progressBar(0);
                            }

                            //show completion message
                            $(taskSelectString + ' span.complete').show()

                            // collapse tree if needed
                            if (elt.hasClass('expanded')) {
                                elt.toggle();
                            }

                            //set status
                            removeAllStatus(elt);
                            elt.addClass(CLASS_COMPLETE);

                        } else if (status == STATUS_FAILED) {

                        }
                    }
               }
            }

            function update() {
                $.getJSON('progress/', {}, processProgressData);
                setTimeout('update()', 5000);
            }

        </script>
        <link rel="stylesheet" type="text/css" href="{{MEDIA_URL}}/jquery.acts_as_tree_table.css" />
        <style>
            * { font-family: Helvetica, Arial, Tahoma; font-size: 12px; font-color: #444; line-height: 25px; padding: 0px; margin: 0px; }

            #content {
                padding-top:30px;
            }

            th {
                background-color:#888888;
                border:1px solid black;
                color:white;
            }

            th.title {
                background-color:#666666;
            }

            td {
                border-bottom: 1px dotted #444444;
                border-left: 1px dotted #444444;
                border-right:1px dotted #444444;
            }

            td, th {
                padding-left:5px;
                padding-right:5px;
            }

            #tasks, #queue, #running {
                border: 0px solid black;
                border-spacing:0;
                border-collapse:collapse;
                margin-top:30px;
                width:100%;
            }

            tr.stripe td {
                background-color:#f6f9fb
            }

            .buttons {
                width: 9em;
            }

            .task_id { width:70px; }
            .task_name { width:150px; }
            .task_name { width:150px; }
            .queue_time, .start_time, .buttons, .last_run {
                text-align:center;
            }
            .queue_time, .start_time, .last_run {
                width:11em;
            }


            .buttons a, .buttons a:hover, .buttons a:visited, .buttons a:active {
                color:blue;
            }

        </style>
{% endblock %}

{% block submenu %}
{% endblock %}

{% block content %}
        <table id="tasks">
            <thead>
                <tr><th colspan="100%" class="title">Available Tasks</th></tr>
                <tr>
                    <th class="task_name">Name</th>
                    <th class="description">Description</th>
                    <th class="last_run">Last Run</th>
                    <th class="buttons"></th>
                </tr>
            </thead>

            {% for key,task in tasks.items %}
                <tr id="{{key}}" class="{% cycle '' 'stripe' %}">
                    <td>{{key}}</td>
                    <td class="description">{{task.description}}</td>
                    <td class="last_run">{% if task.last_run %}{{task.last_run}}{%else%}<i>never</i>{%endif%}</td>
                    <td class="buttons">
                        {% if perms.pydra_server.can_run_tasks %}
                            <a class="button_run" type="button" value="Run" href="#">Run</a>
                            <a type="button" value="Schedule" href="#">Schedule</a>
                        {% endif %}
                        <a type="button" value="Log" href="#">Log</a>
                    </td>
                </tr>
            {% endfor %}
        </table>

        <table id="queue">
            <thead>
                <tr><th colspan="100%" class="title">Queued Jobs</th></tr>
                <tr>
                    <th class="task_id">ID</th>
                    <th class="task_name">Name</th>
                    <th class="description">Description</th>
                    <th class="queue_time">Time Queued</th>
                    <th class="buttons"></th>
                </tr>
            </thead>

            {% for task in queue %}
                <tr id="{{task.id}}" class="{% cycle '' 'stripe' %}">
                    <td class="task_id">{{task.task_key}}</td>
                    <td class="task_name">{{tasks|task_description:task.task_key}}</td>
                    <td class="queue_time">{{task.queued}}</td>
                    <td class="buttons">
                        {% if perms.pydra_server.can_manage_queue %}
                            <input type="button" value="Up"/>
                            <input type="button" value="Down"/>
                        {% endif %}
                        {% if perms.pydra_server.can_run_tasks %}<input class="button_cancel" type="button" value="Cancel"/>{% endif %}
                    </td>
                </tr>
            {% endfor %}
        </table>

        <table id="running">
            <thead>
                <tr><th id="title" colspan="100%" class="title">Running Jobs</th></tr>
                <tr>
                    <th class="task_id">ID</th>
                    <th class="task_name">Name</th>
                    <th class="decription">Description</th>
                    <th class="queue_time">Time Queued</th>
                    <th class="start_time">Time Started</th>
                    <th class="buttons"></th>
                </tr>
            </thead>

            {% for task in running %}
                <tr id="instance_{{task.id}}" class="{% cycle '' 'stripe' %}">
                    <td class="task_id">{{task.id}}</td>
                    <td class="task_name">{{task.task_key}}</td>
                    <td class="description">{{tasks|task_description:task.task_key}}</td>
                    <td class="queue_time">{{task.queued}}</td>
                    <td class="start_time">{{task.started}}</td>
                    <td class="buttons">
                        {% if perms.pydra_server.can_run_tasks %}<input class="button_cancel" type="button" value="Cancel"/>{% endif %}
                    </td>
                </tr>
            {% endfor %}
        </table>

    </div>
{% endblock %}