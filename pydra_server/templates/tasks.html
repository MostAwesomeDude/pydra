<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--
    Copyright 2009 Oregon State University

    This file is part of Pydra.

    Pydra is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Pydra is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Pydra.  If not, see <http://www.gnu.org/licenses/>.
-->

{% load pydra_extras %}

<html>
    <head>
        <script type="text/javascript" src="{{MEDIA_URL}}/js/jquery-1.3.1.min.js"></script>
        <script type="text/javascript" src="{{MEDIA_URL}}/js/jquery.progressbar.js"></script>
        <script type="text/javascript" src="{{MEDIA_URL}}/js/json2.js"></script>
        <script type="text/javascript" src="{{MEDIA_URL}}/js/jquery.acts_as_tree_table.js"></script>

        <script>
            $(document).ready(function() {
                //$('table[id^=taskstable-]').acts_as_tree_table({default_state:'collapsed'});

                //$('span.complete').hide();
                //$('span.progressbar').hide();
                //$('span.progressbar').progressBar({barImage: 'http://doors.osuosl.org/media/images/progressbg_yellow.gif', boxImage:'http://doors.osuosl.org/media/images/progressbar.gif'});

                $('.button_run').live('click', function(evt) {
                    $.post('run/', {'key':evt.target.parentNode.parentNode.id});
                });

                $('.button_cancel').live('click', function(evt) {
                    $.post('cancel/', {'i':evt.target.parentNode.parentNode.id});
                });

                // AUTO UPDATES ARE DISABLED
                //update();
            });

            var STATUS_FAILED = -1;
            var STATUS_STOPPED = 0;
            var STATUS_RUNNING = 1;
            var STATUS_PAUSED = 2;
            var STATUS_COMPLETE = 3;

            var CLASS_FAILED = 'status-failed';
            var CLASS_STOPPED = 'status-stopped';
            var CLASS_RUNNING = 'status-running';
            var CLASS_PAUSED = 'status-paused';
            var CLASS_COMPLETE = 'status-complete';

            function removeAllStatus(node){
                node.removeClass(CLASS_FAILED);
                node.removeClass(CLASS_STOPPED);
                node.removeClass(CLASS_RUNNING);
                node.removeClass(CLASS_PAUSED);
                node.removeClass(CLASS_COMPLETE);
            }

            function processProgressData(incommingJSON) {
                statusMessage = JSON.parse(incommingJSON);
                for (key in statusMessage){
                    progressArray = statusMessage[key]['status'];

                    for (i=0; i<progressArray.length; i++){
                        // store array as vars for readability
                        id          = progressArray[i]['id'];
                        status      = progressArray[i]['status'];
                        progress    = progressArray[i]['progress'];
                        msg         = progressArray[i]['msg'];

                        taskSelectString = '#'+key+' #task-' + key + '-' + id
                        elt = $(taskSelectString);
                        // check status and update if needed
                        if (status == STATUS_STOPPED && !elt.hasClass(CLASS_STOPPED)) {
                            // hide progress bar 
                            if (elt.hasClass(CLASS_RUNNING) || elt.hasClass(CLASS_PAUSED)) {
                                $(taskSelectString + ' span.progressbar').hide()
                            }
                            //hide completion message
                            if (elt.hasClass(CLASS_COMPLETE)) {
                                $(taskSelectString + ' span.complete').hide()
                            }

                            //set status
                            removeAllStatus(elt);
                            elt.addClass(CLASS_STOPPED);


                        } else if (status == STATUS_RUNNING) {
                            //hide completion message
                            if (elt.hasClass(CLASS_COMPLETE)) {
                                $(taskSelectString + ' span.complete').hide()
                            }

                            // show statusbar
                            if (!(elt.hasClass(CLASS_RUNNING) || elt.hasClass(CLASS_PAUSED))) {
                                $(taskSelectString + ' span.progressbar').show();
                            }

                            // expand tree if needed
                            if (elt.hasClass('collapsed')) {
                                elt.toggle();
                            }

                            //update progressbar
                            $(taskSelectString + ' .progressbar').progressBar(progress);

                            //set status
                            removeAllStatus(elt);
                            elt.addClass(CLASS_RUNNING);

                        } else if (status == STATUS_PAUSED) {
                            // show statusbar
                            if (!(elt.hasClass(CLASS_RUNNING) || elt.hasClass(CLASS_PAUSED))) {
                                $(taskSelectString + ' span.progressbar').show();
                            }

                            //hide completion message
                            if (id.hasClass(CLASS_RUNNING) || id.hasClass(CLASS_PAUSED)) {
                                $(taskSelectString + ' span.complete').hide()
                            }

                            //set status
                            removeAllStatus(elt);
                            elt.addClass(STATUS_PAUSED);

                        } else if (status == STATUS_COMPLETE && !elt.hasClass(CLASS_COMPLETE)) {
                            // hide statusbar
                            if (elt.hasClass(CLASS_RUNNING) || elt.hasClass(CLASS_PAUSED)) {
                                bar = $(taskSelectString + ' span.progressbar')
                                bar.hide();
                                bar.progressBar(0);
                            }

                            //show completion message
                            $(taskSelectString + ' span.complete').show()

                            // collapse tree if needed
                            if (elt.hasClass('expanded')) {
                                elt.toggle();
                            }

                            //set status
                            removeAllStatus(elt);
                            elt.addClass(CLASS_COMPLETE);

                        } else if (status == STATUS_FAILED) {

                        }
                    }
               }
            }

            function update() {
                $.post('progress/',{},processProgressData);
                setTimeout('update()', 2000);
            }

        </script>
        <link rel="stylesheet" type="text/css" href="{{MEDIA_URL}}/jquery.acts_as_tree_table.css" />
        <style>
            * { font-family: Helvetica, Arial, Tahoma; font-size: 12px; font-color: #444; line-height: 25px; padding: 0px; margin: 0px; }

            #content {
                width:100%;
                margin-left:10%;
            }

            #tasks {
                border: 1px solid black;
                width:80%;
                margin-top:20px;
            }

            #queue {
                border: 1px solid black;
                width:80%;
                margin-top:20px;
            }

            #running {
                border:1px solid black;
                width:80%;
                margin-top:20px;
            }

            td.center {
                text-align:center;
            }

        </style>
    </head>
    <body>
    {% include 'header.html' %}
    <div id="content">

        <table id="tasks">
            <thead>
                <tr><th colspan="100%">Available Tasks</th></tr>
                <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Last Run</th>
                    <th>Recurrence</th>
                    <th>Commands</th>
                </tr>
            </thead>

            {% for key,task in tasks.items %}
                <tr id="{{key}}">
                    <td>{{key}}</td>
                    <td>{{task.description}}</td>
                    <td class="center">{% if task.last_run %}{{task.last_run}}{%else%}<i>never</i>{%endif%}</td>
                    <td class="center">[schedule]</td>
                    <td class="center">
                        <input class="button_run" type="button" value="Run"/>
                        <input type="button" value="Schedule"/>
                        <input type="button" value="Log"/>
                    </td>
                </tr>
            {% endfor %}
        </table>

        <table id="queue">
            <thead>
                <tr><th colspan="100%">Queued Jobs</th></tr>
                <tr>
                    <th></th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Time Queued</th>
                </tr>
            </thead>

            {% for task in queue %}
                <tr id="{{task.id}}">
                    <td></td>
                    <td>{{task.task_key}}</td>
                    <td>{{tasks|task_description:task.task_key}}</td>
                    <td class="center">{{task.queued}}</td>
                    <td>
                        <input type="button" value="Up"/>
                        <input type="button" value="Down"/>
                        <input class="button_cancel" type="button" value="Cancel"/>
                    </td>
                </tr>
            {% endfor %}
        </table>

        <table id="running">
            <thead>
                <tr><th id="title" colspan="100%">Running Jobs</th></tr>
                <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Time Queued</th>
                    <th>Time Started</th>
                    <th></th>
                </tr>
            </thead>

            {% for task in running %}
                <tr id="{{task.id}}">
                    <td>{{task.task_key}}</td>
                    <td>{{tasks|task_description:task.task_key}}</td>
                    <td class="center">{{task.queued}}</td>
                    <td class="center">{{task.started}}</td>
                    <td class="center">
                        <input class="button_cancel" type="button" value="Stop"/>
                    </td>
                </tr>
            {% endfor %}
        </table>

    </div>

    </body>
</html>
